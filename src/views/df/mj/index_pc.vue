<template>
  <a-layout v-loading="loadingRef" loading-tip="Âä†ËΩΩ‰∏≠...">
    <a-row class="flex-container">
      <!-- ÊäΩÂ±âÈÉ®ÂàÜÔºå‰ªÖÂú®ÁßªÂä®Á´ØÊòæÁ§∫ -->
      <a-drawer :visible="isDrawerVisible" width="95%" @close="isDrawerVisible = false">
        <a-card style="padding-bottom: 0">
          <a-tabs v-model="activeTab">
            <a-tab-pane key="TextToImg" tab="ÊñáÁîüÂõæ">
              <TextToImage
                style="text-align: center"
                @startLoading="startLoadingHandler"
                @endLoading="endLoadingHandler"
              />
            </a-tab-pane>
            <a-tab-pane key="MixImage" tab="Ê∑∑Âõæ">
              <Blend @startLoading="startLoadingHandler" @endLoading="endLoadingHandler" />
            </a-tab-pane>
            <a-tab-pane key="Describe" tab="Ëß£ÊûêÂõæ">
              <Describe @startLoading="startLoadingHandler" @endLoading="endLoadingHandler" />
            </a-tab-pane>
          </a-tabs>
        </a-card>
      </a-drawer>

      <div v-if="!isMobile && !showTabs" class="toggle-button-left" @click="toggleTabs">
        <a-button shape="circle" size="small">
          <Icon
            icon="bx:right-arrow"
            class="vel-icon icon"
            aria-hidden="true"
            size="16"
            v-if="!showTabs"
          />
          <Icon icon="bx:left-arrow" class="vel-icon icon" aria-hidden="true" size="16" v-else />
        </a-button>
      </div>

      <a-col v-show="!isMobile && showTabs" class="left-menu">
        <div class="toggle-button-right" @click="toggleTabs">
          <a-button shape="circle" size="small" style="align-items: center">
            <Icon icon="bx:left-arrow" class="vel-icon icon" aria-hidden="true" size="16" />
          </a-button>
        </div>
        <a-card
          :bordered="true"
          class="no-padding-header ar-card"
          :bodyStyle="{ padding: '0px 5px' }"
          :headStyle="{ padding: '0px' }"
        >
          <template #title>
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 45px;
              "
            >
              <div style="margin-left: 10px">
                <span style="font-weight: bold">üè¢AIÁªòÁîªÂ∑•‰ΩúÂå∫</span>-{{ currentSpace.title }}
              </div>
              <div
                style="
                  display: flex;
                  flex-direction: row;
                  justify-content: right;
                  margin-right: 10px;
                  font-size: 15px;
                "
                ><a-tooltip title="üçßÂØºÂÖ•DISCORDËÆ∞ÂΩïÔºåÂèØ‰ª•Â∞ÜdiscordÁöÑÂõæÁâáÂØºÂÖ•ËøõÊù•ËøõË°åÁÆ°ÁêÜÂì¶~">
                  <a-button @click="showImportView" style="padding: 0 5px; border-radius: 5px"
                    ><Icon icon="mingcute:discord-line" size="22"
                  /></a-button>
                </a-tooltip>
                <a-tooltip title="ü•ÉÂ∑•‰ΩúÁ©∫Èó¥ÁÆ°ÁêÜÔºåÂêÑÁ©∫Èó¥Êï∞ÊçÆÈöîÁ¶ªÔºåÂêéÁª≠ÂèØÈÇÄËØ∑Â•ΩÂèãÂä†ÂÖ•‰Ω†ÁöÑÁ©∫Èó¥~">
                  <a-button
                    @click="showWorkerSpace"
                    style="margin-left: 5px; padding: 0 5px; border-radius: 5px"
                    ><Icon icon="material-symbols:space-dashboard-outline" size="22"
                  /></a-button>
                </a-tooltip>
              </div>
            </div>
          </template>

          <a-tabs class="edit-tab" v-model="activeTab">
            <a-tab-pane key="TextToImg" tab="üåïÊñáÁîüÂõæ">
              <TextToImage
                style="text-align: center"
                @startLoading="startLoadingHandler"
                @endLoading="endLoadingHandler"
                :spaceId="currentSpace.id"
              />
            </a-tab-pane>
            <a-tab-pane key="MixImage" tab="üåóÊ∑∑Âõæ">
              <Blend
                @startLoading="startLoadingHandler"
                @endLoading="endLoadingHandler"
                :spaceId="currentSpace.id"
              />
            </a-tab-pane>
            <a-tab-pane key="Describe" tab="üåëËß£ÊûêÂõæ">
              <Describe
                @startLoading="startLoadingHandler"
                @endLoading="endLoadingHandler"
                :spaceId="currentSpace.id"
              />
            </a-tab-pane>
            <a-tab-pane key="other" disabled tab="üééÂÖ∂ÂÆÉ" />
          </a-tabs>
        </a-card>
      </a-col>

      <a-col class="right-content">
        <a-content>
          <JobList
            :spaceId="currentSpace.id"
            ref="jobListRef"
            @openDrawer="isDrawerVisible = true"
          />
        </a-content>
      </a-col>
    </a-row>
    <div>
      <a-modal width="80%" v-model:visible="isShowWorkSpace" title="Â∑•‰ΩúÁ©∫Èó¥ÁÆ°ÁêÜ">
        <template #footer>
          <a-button key="submit" :loading="compState.loading" @click="closeWorkSpace"
            >ÊöÇ‰∏çÊìç‰Ωú</a-button
          >
        </template>
        <a-spin :spinning="compState.loading" tip="Êï∞ÊçÆÂä†ËΩΩ‰∏≠...">
          <a-card :bodyStyle="{ padding: '0px 10px 6px ' }">
            <!-- <div style="width: 100%; overflow-x: auto"> -->
            <a-button
              type="primary"
              class="editable-add-btn"
              style="margin-top: 8px; margin-bottom: 8px; margin-left: 5px"
              @click="addUserSpace(null)"
              >Êñ∞Â¢û</a-button
            >
            <a-table
              :dataSource="tableData"
              rowKey="id"
              :row-class-name="(_record, index) => (index % 2 === 1 ? 'table-striped' : null)"
              :scroll="{ x: 'max-content', y: 380 }"
              :pagination="false"
              size="small"
            >
              <a-table-column title="ËÆ∞ÂΩïid" dataIndex="id" key="id" v-if="false" align="center" />
              <a-table-column
                title="Â∑•‰ΩúÁ©∫Èó¥ÂêçÁß∞"
                dataIndex="title"
                key="title"
                align="center"
                width="150px"
              />
              <a-table-column title="Â§áÊ≥®" dataIndex="remark" key="remark" align="center" />

              <a-table-column
                title="ÂàõÂª∫Êó∂Èó¥"
                dataIndex="gmtCreate"
                key="gmtCreate"
                align="center"
              />

              <a-table-column title="Êìç‰Ωú" key="actions" style="width: 150px">
                <template #default="{ record }">
                  <a-button-group>
                    <a-popconfirm
                      title="Âà†Èô§ÂêéËØ•Á©∫Èó¥ÂõæÁâáÂ∞Ü‰∏¢Â§±ÔºàÁõÆÂâçÊöÇÊú™ÂÅöËøÅÁßªÈÄªËæëÔºâÔºåÊòØÂê¶Á°ÆËÆ§Âà†Èô§?"
                      ok-text="Á°ÆËÆ§Âà†Èô§"
                      cancel-text="ÂèñÊ∂à"
                      @confirm="deleteHandle(record.id)"
                    >
                      <a-button type="primary" danger v-if="record.defaultFlag === 'N'"
                        >Âà†Èô§</a-button
                      >
                    </a-popconfirm>
                    <a-button
                      type="primary"
                      @click="addUserSpace(record)"
                      v-if="record.defaultFlag === 'N'"
                      >ÁºñËæë</a-button
                    >
                    <a-button @click="selectSpace(record)">ÈÄâÊã©</a-button>
                  </a-button-group>
                </template>
              </a-table-column>
            </a-table>
          </a-card>
        </a-spin>
      </a-modal>
    </div>
    <div>
      <a-modal
        style="width: 300px"
        ok-text="Êèê‰∫§"
        @ok="onSubmitUserSpace"
        v-model:visible="isShowUserSpaceSave"
        title="Â∑•‰ΩúÁ©∫Èó¥‰øùÂ≠ò"
      >
        <a-spin size="small" :spinning="compState.loading">
          <a-card>
            <a-form :model="userSpaceForm" layout="vertical" ref="userSpaceFormRef">
              <a-row gutter="24">
                <a-col :span="24">
                  <a-form-item
                    label="Â∑•‰ΩúÁ©∫Èó¥Âêç"
                    :rules="[
                      {
                        required: true,
                        message: 'Â∑•‰ΩúÁ©∫Èó¥ÂêçÊòØÂøÖÂ°´È°π',
                      },
                    ]"
                    name="title"
                  >
                    <a-input v-model:value="userSpaceForm.title" placeholder="ËæìÂÖ•Á©∫Èó¥ÂêçÁß∞" />
                  </a-form-item>
                </a-col>
              </a-row>
              <a-row gutter="24">
                <a-col :span="24">
                  <a-form-item label="Â§áÊ≥®">
                    <a-textarea
                      v-model:value="userSpaceForm.remark"
                      placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®~"
                      allow-clear
                      :maxlength="128"
                      :auto-size="{ minRows: 3, maxRows: 5 }"
                    />
                  </a-form-item>
                </a-col>
              </a-row>
            </a-form>
          </a-card>
        </a-spin>
        <template #footer>
          <a-button @click="onSubmitUserSpace" :loading="compState.loading" type="primary"
            >Êèê‰∫§</a-button
          >
        </template>
      </a-modal>
    </div>

    <!-- DiscordÊï∞ÊçÆÂØºÂÖ•ÂºπÁ™ó  -->
    <div>
      <a-modal
        v-model:visible="importForm.viewFlag"
        title="üî•ÂØºÂÖ•DiscordÊï∞ÊçÆ"
        :confirmLoading="importForm.loading"
        @ok="importDiscordMessage()"
      >
        <a-spin :spinning="importForm.loading">
          <a-card
            :bordered="false"
            :bodyStyle="{
              padding: '10px 15px',
              width: '100%',
              'align-items': 'center',
              'font-size': '10px',
            }"
          >
            <a-row style="padding: 15px">
              <a-col span="24">
                <span style="font-size: 10"
                  >üìå
                  Âè™ËÉΩÈÄâËá™ÊúâÁöÑDISCORDË¥¶Âè∑ÔºÅÂ¶ÇÊûúchannelÊ≤°ÊâæÂà∞ÁöÑËØùÔºåËØ∑ÂéªË¥¶Êà∑ÁÆ°ÁêÜÂêåÊ≠•DiscordÊõ¥Êñ∞‰∏ãÔºÅÂπ∂Âà∑Êñ∞ÂΩìÂâçÈ°µÈù¢ÔºÅ</span
                >
              </a-col>
            </a-row>
            <a-row :gutter="[0, 2]" type="flex">
              <a-col flex="120px">
                <a-tag class="quality-tag" color="default">üç∫ÂØºÂÖ•Á©∫Èó¥ </a-tag>
              </a-col>
              <a-col flex="auto">
                <a-select
                  v-model:value="importForm.spaceId"
                  style="width: 100%"
                  placeholder="ËØ∑ÈÄâÊã©ÂØºÂÖ•Á©∫Èó¥"
                  :options="importForm.spaceOptions"
                />
              </a-col>
            </a-row>
            <!-- <a-row :gutter="[0, 2]" type="flex" style="margin-top: 7px">
              <a-col flex="80px">
                <a-tag class="quality-tag" color="default">üçãÊâßË°åË¥¶Âè∑ </a-tag>
              </a-col>
              <a-col flex="auto">
                <a-select
                  @change="handleSelectAccount"
                  style="width: 100%; height: 32px"
                  v-model:value="importForm.accountId"
                  :options="importForm.accountOptions"
                />
              </a-col>
            </a-row> -->
            <a-row :gutter="[0, 2]" type="flex" style="margin-top: 7px">
              <a-col flex="120px">
                <a-tag class="quality-tag" color="default">üçãDiscordË¥¶Âè∑ </a-tag>
              </a-col>
              <a-col flex="auto">
                <a-select
                  @change="onSelectDiscordUser"
                  style="width: 100%; height: 32px"
                  v-model:value="importForm.discordUserId"
                  :options="importForm.discordUserOptions"
                  placeholder="ËØ∑ÈÄâÊã©DiscordË¥¶Âè∑"
                />
              </a-col>
            </a-row>
            <a-row :gutter="[0, 2]" type="flex" style="margin-top: 7px">
              <a-col flex="120px">
                <a-tag class="quality-tag" color="default">üçµÂêåÊ≠•ÊúçÂä°Âô® </a-tag>
              </a-col>
              <a-col flex="auto">
                <a-select
                  @change="onSelectGuild"
                  style="width: 100%; height: 32px"
                  v-model:value="importForm.guildId"
                  :options="importForm.guildOptions"
                  placeholder="ËØ∑ÈÄâÊã©ÊâßË°åÁöÑÊúçÂä°Âô®"
                />
              </a-col>
            </a-row>
            <a-row :gutter="[0, 2]" type="flex" style="margin-top: 7px">
              <a-col flex="120px">
                <a-tag class="quality-tag" color="default">üç•ÂêåÊ≠•È¢ëÈÅì </a-tag>
              </a-col>
              <a-col flex="auto">
                <a-select
                  v-model:value="importForm.channelId"
                  style="width: 100%"
                  placeholder="ËØ∑ÈÄâÊã©ChannelId"
                  :options="importForm.channelOptions"
                />
              </a-col>
            </a-row>
          </a-card>
        </a-spin>
      </a-modal>
    </div>
  </a-layout>
</template>

<script lang="ts" setup>
  import JobList from './JobList.vue';
  import Icon from '/@/components/Icon/Icon.vue';
  import Blend from './Blend.vue';
  import { ref, onMounted, reactive } from 'vue';
  import TextToImage from './TextToImg.vue';
  import Describe from './Describe.vue';
  import {
    RightOutlined,
    LeftOutlined,
    SettingOutlined,
    ClusterOutlined,
  } from '@ant-design/icons-vue';
  import {
    saveUserSpace,
    deleteSpace,
    allUserSpace,
    importMessage,
    channelList,
  } from '/@/api/df/workSpace';

  import {
    WorkSpaceListResp,
    WorkSpaceSaveReq,
    ImportDiscordMessageReq,
    DiscordChannel,
  } from '/@/api/df/model/workSpaceModel';
  import { availableList } from '/@/api/df/account';
  import { useRoute } from 'vue-router';
  import { useUserStore } from '/@/store/modules/user';
  import { useMessage } from '/@/hooks/web/useMessage';
  import { discordApi } from './discord';

  const { createMessage, createSuccessModal, createErrorModal, createInfoModal } = useMessage();
  const {
    importFormRef,
    importForm,
    showImportView,
    onSelectDiscordUser,
    onSelectGuild,
    queryDiscordList,
  } = discordApi();
  const userStore = useUserStore();

  const route = useRoute();

  const activeTab = ref(route.query.activeTab || 'TextToImageForm');
  const loadingRef = ref(false);
  const jobListRef = ref();
  const isDrawerVisible = ref(false);
  const isMobile = ref(window.innerWidth < 768);
  const showTabs = ref(true);
  const currentSpace = reactive<WorkSpaceSaveReq>({
    id: null,
    title: '',
    remark: '',
  });

  const toggleTabs = () => {
    showTabs.value = !showTabs.value;
  };

  window.addEventListener('resize', () => {
    isMobile.value = window.innerWidth < 768;
  });

  const startLoadingHandler = () => {
    loadingRef.value = true;
  };

  const endLoadingHandler = () => {
    setTimeout(() => {
      loadingRef.value = false;
    }, 2);
    if (jobListRef.value) {
      jobListRef.value.onSearch();
    } else {
      console.warn('jobListRef is not yet initialized');
    }
  };

  //===================================== ÂØºÂÖ•discodËÆ∞ÂΩï ================================
  onMounted(async () => {
    await queryDiscordList();
  });

  const importDiscordMessage = async () => {
    if (importForm.value.spaceId === '') {
      createMessage.error('ËØ∑ÈÄâÊã©ÂØºÂÖ•Á©∫Èó¥ÔºÅ');
      return;
    }
    if (importForm.value.discordUserId === '') {
      createMessage.error('ËØ∑ÈÄâÊã©DiscordË¥¶Âè∑ÔºÅ');
      return;
    }
    if (importForm.value.discordUserId === '') {
      createMessage.error('ËØ∑ÈÄâÊã©ÂêåÊ≠•ÊúçÂä°Âô®ÔºÅ');
      return;
    }
    if (importForm.value.channelId === '') {
      createMessage.error('ËØ∑ÈÄâÊã©ÂêåÊ≠•È¢ëÈÅìÔºÅ');
      return;
    }
    importForm.value.loading = true;
    console.log('---------------------------------');
    try {
      await importMessage({
        accountId: importForm.value.accountId,
        spaceId: importForm.value.spaceId,
        discordUserId: importForm.value.discordUserId,
        guildId: importForm.value.guildId,
        channelId: importForm.value.channelId,
      });
      importForm.value.viewFlag = false;
      createMessage.success('Ê∂àÊÅØÂØºÂÖ•ÊàêÂäüÔºÅËØ∑Âà∞Áõ∏ÂÖ≥Á©∫Èó¥Êü•ÁúãÔºÅ');
    } finally {
      importForm.value.loading = false;
    }
  };

  //=====================================Â∑•‰ΩúÁ©∫Èó¥Áõ∏ÂÖ≥====================================
  const compState = reactive({
    absolute: true,
    loading: false,
    tip: 'Âä†ËΩΩ‰∏≠...',
  });

  const isShowWorkSpace = ref(false);
  const isShowUserSpaceSave = ref(false);
  const userSpaceFormRef = ref();
  const userSpaceForm = reactive<WorkSpaceSaveReq>({
    id: null,
    title: '',
    remark: '',
  });

  // ‰∏ªtable Êï∞ÊçÆ
  const tableData = ref<WorkSpaceListResp[]>([
    // Êõ¥Â§öÊï∞ÊçÆ...
  ]);
  //ÊòæÁ§∫Â∑•‰ΩúÁ©∫Èó¥
  const showWorkerSpace = () => {
    isShowWorkSpace.value = true;
    compState.loading = false;
  };

  const closeWorkSpace = () => {
    isShowWorkSpace.value = false;
    compState.loading = false;
  };
  //Â∑•‰ΩúÁ©∫Èó¥ÂàóË°®
  const querySpace = async () => {
    compState.loading = true;
    try {
      const response = await allUserSpace({});
      console.log(response);
      tableData.value = response;
      // ‰ΩøÁî® map ÊñπÊ≥ïËΩ¨Êç¢Êï∞ÁªÑ
      const transformedList = response.map((item) => ({
        label: item.title,
        value: item.id,
      }));
      // Â¶ÇÊûúÊÇ®ÊÉ≥Âú®ËΩ¨Êç¢ÂêéÁöÑÊï∞ÁªÑÂâçÈù¢Ê∑ªÂä†‰∏Ä‰∏™ÁâπÂÆöÁöÑÂØπË±°ÔºåÂèØ‰ª•‰ΩøÁî®‰ª•‰∏ãÊñπÊ≥ïÔºö
      const finalList = [{ label: 'ËØ∑ÈÄâÊã©ÂØºÂÖ•Á©∫Èó¥', value: '' }, ...transformedList];
      importForm.value.spaceOptions = finalList;
    } finally {
      compState.loading = false;
    }
  };

  const selectSpace = (item) => {
    currentSpace.title = item.title;
    currentSpace.id = item.id;
    isShowWorkSpace.value = false;
    //ÁºìÂ≠ò
    const setting = {};
    setting['spaceId'] = item.id;
    setting['spaceName'] = item.title;
    userStore.syncSetting(setting);
  };

  onMounted(async () => {
    await querySpace();
    const item = tableData.value[0];
    currentSpace.id = item.id;
    currentSpace.title = item.title;
  });

  const addUserSpace = (item) => {
    if (item) {
      for (let key in userSpaceForm) {
        if (item[key] !== undefined) {
          userSpaceForm[key] = item[key];
        }
      }
    } else {
      userSpaceForm.id = null;
      userSpaceForm.title = '';
      userSpaceForm.remark = '';
    }
    isShowUserSpaceSave.value = true;
  };

  const onSubmitUserSpace = async () => {
    try {
      compState.loading = true;
      await userSpaceFormRef.value.validate();
      console.log('Form is valid, submitting...');
      await saveUserSpace(userSpaceForm);
      isShowUserSpaceSave.value = false;
      querySpace();
    } catch (error) {
      console.log('Form validation failed:', error);
    } finally {
      compState.loading = false;
    }
  };
  const deleteHandle = async (id) => {
    compState.loading = true;
    console.log('Form is valid, submitting...');
    await deleteSpace({ id });
    querySpace();
  };
</script>

<style scoped>
  .flex-container {
    display: flex;
    position: relative;
  }

  .left-menu {
    position: relative;
    flex: 0 0 370px;
  }

  .right-content {
    flex: 1;
    overflow-x: auto;
  }

  .toggle-button-left {
    position: absolute;
    z-index: 2;
    top: 50%;
    left: 5px; /* Â∞ÜÊåâÈíÆÊîæÂú®Â∑¶‰æß */
    transform: translateY(-50%);
  }

  .toggle-button-right {
    position: absolute;
    z-index: 2;
    top: 50%;
    right: 0; /* Â∞ÜÊåâÈíÆÊîæÂú®Â∑¶‰æßËèúÂçïÁöÑÂè≥‰æß */
    transform: translateY(-50%);
  }

  .flex-container:not(.showTabs) .my-button-icon {
    right: 10px; /* ÂΩìÂ∑¶‰æßËèúÂçïÈöêËóèÊó∂ */
  }

  .toggle-button-right span.anticon {
    vertical-align: -0.125em !important;
  }

  .toggle-button-left span.anticon {
    vertical-align: -0.125em !important;
  }

  .no-padding-header >>> .ant-card-head-title {
    padding: 0 !important;
  }

  .quality-tag {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 32px;
    margin-right: 0;
    font-size: 15px;
  }
</style>
