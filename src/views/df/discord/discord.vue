<template>
  <a-layout>
    <a-row style="height: 70px">
      <a-col :span="24">
        <a-card
          style="display: flex; align-items: center; height: 100%"
          :bodyStyle="{ padding: '0 5px 0px 24px' }"
        >
          <a-form layout="inline">
            <a-form-item>
              <a-select
                v-model:value="queryForm.discordState"
                placeholder="ËØ∑ÈÄâÊã©discordÁä∂ÊÄÅ"
                style="width: 150px"
              >
                <a-select-option value="NORMAL">Ê≠£ Â∏∏</a-select-option>
                <a-select-option value="EXPIRED">TOKENËøáÊúü</a-select-option>
                <a-select-option value="VERIFY_HUMAN">È™åËØÅ‰∫∫Á±ª</a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item>
              <a-select
                v-model:value="queryForm.mjState"
                placeholder="ËØ∑ÈÄâÊã©mjÁä∂ÊÄÅ"
                style="width: 150px"
              >
                <a-select-option value="NORMAL">Ê≠£ Â∏∏</a-select-option>
                <a-select-option value="STOP">ËÆ¢ÈòÖËøáÊúü</a-select-option>
                <a-select-option value="BAN">BAN</a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item>
              <a-space>
                <a-button-group>
                  <a-button @click="onSearch">Êü•ËØ¢</a-button>
                  <a-button type="primary" @click="showDiscordForm">Êñ∞Â¢û</a-button>
                </a-button-group>
              </a-space>
            </a-form-item>
          </a-form>
        </a-card>
      </a-col>
    </a-row>

    <div style="margin-top: 1px">
      <a-table
        :dataSource="tableData"
        rowKey="id"
        :loading="tableLoading"
        :row-class-name="(_record, index) => (index % 2 === 1 ? 'table-striped' : null)"
        :scroll="{ x: 'max-content', y: props.contentHeight - 230 }"
        :pagination="false"
      >
        <a-table-column
          title="Ë¥¶Êà∑Âêç"
          dataIndex="userName"
          key="userName"
          v-if="false"
          align="center"
          :width="150"
        />
        <a-table-column
          title="ÂÖ®Â±ÄÂêç"
          dataIndex="globalName"
          key="globalName"
          align="center"
          :width="150"
        />
        <a-table-column title="ÈÇÆÁÆ±" dataIndex="email" key="email" align="center" :width="150" />

        <a-table-column
          title="USEÂπ∂Âèë"
          dataIndex="useConcurrent"
          key="useConcurrent"
          align="center"
          :width="100"
        />
        <a-table-column
          title="MAXÂπ∂Âèë"
          dataIndex="maxConcurrent"
          key="maxConcurrent"
          align="center"
          :width="100"
        />
        <a-table-column
          title="DiscordÁä∂ÊÄÅ"
          dataIndex="discordState"
          key="discordState"
          align="center"
          :width="120"
        >
          <template #default="{ text }">
            <a-badge
              :status="getDiscordStateContent(text).status"
              :text="getDiscordStateContent(text).text"
            />
          </template>
        </a-table-column>
        <a-table-column
          title="MJÁä∂ÊÄÅ"
          dataIndex="mjState"
          key="mjState"
          align="center"
          :width="100"
        >
          <template #default="{ text }">
            <a-tag :color="getMjStateContent(text).color">{{ getMjStateContent(text).text }}</a-tag>
          </template>
        </a-table-column>
        <a-table-column
          title="MJÂ•óÈ§ê"
          dataIndex="mjSubscribe"
          key="mjSubscribe"
          align="center"
          :width="100"
        />

        <a-table-column
          title="Áî®Êà∑TOKEN"
          dataIndex="userToken"
          key="userToken"
          align="center"
          :width="120"
        >
          <template #default="{ text }">
            <a-popover placement="top" trigger="click">
              <template #title></template>
              <template #content>
                {{ text }}
                <a-button size="small" @click="() => copyText(text)">üê£Â§çÂà∂</a-button>
              </template>
              <a-button size="small">üôâÊü•ÁúãTOKEN</a-button>
            </a-popover>
          </template>
        </a-table-column>
        <a-table-column
          title="ÂºÇÂ∏∏‰ø°ÊÅØ"
          dataIndex="errorMsg"
          key="errorMsg"
          align="center"
          :width="120"
        >
          <template #default="{ text }">
            <a-popover placement="top" trigger="click">
              <template #title></template>
              <template #content> {{ text }} </template>
              <a-button size="small" type="danger" v-if="text">üôäÂºÇÂ∏∏‰ø°ÊÅØ</a-button>
            </a-popover>
          </template>
        </a-table-column>

        <!-- <a-table-column title="ÂºÇÂ∏∏‰ø°ÊÅØ" dataIndex="errorMsg" key="errorMsg" align="center" /> -->

        <a-table-column title="Êìç‰Ωú" key="actions" fixed="right" :width="200">
          <template #default="{ record }">
            <a-button-group>
              <!-- <a-button @click="showDiscordForm" disabled>Ê¶ÇÂÜµ</a-button> -->
              <a-button @click="showDiscordForm" disabled>ÈÖçÁΩÆ</a-button>
              <a-button type="warning" @click="showDiscordForm(record)" v-if="record.state != 'Y'"
                >Âà∑Êñ∞TOKEN</a-button
              >
            </a-button-group>
          </template>
        </a-table-column>
      </a-table>
    </div>
    <!-- ÊûÑÂª∫discordË¥¶Âè∑ -->
    <a-modal
      v-model:visible="discordForm.viewFlag"
      :title="discordForm.title"
      ok-text="Á´ãÂç≥ÊâßË°å"
      @ok="addDiscord"
      :confirmLoading="discordForm.loading"
    >
      <a-card>
        <a-spin :spinning="discordForm.loading" :tip="discordForm.loadingTitle">
          <a-form :model="discordForm" layout="vertical" ref="discordFormRef">
            <a-row gutter="24">
              <a-col :span="24">
                <a-form-item
                  label="Discord token"
                  :rules="[
                    {
                      required: true,
                      message: 'token‰∏çËÉΩ‰∏∫Á©∫',
                    },
                  ]"
                  name="token"
                >
                  <a-input v-model:value="discordForm.token" placeholder="ËæìÂÖ•token" />
                </a-form-item>
              </a-col>
            </a-row>
          </a-form>
        </a-spin>
      </a-card>
    </a-modal>
  </a-layout>
</template>

<script lang="ts" setup>
  import { ref, unref, onMounted, defineProps } from 'vue';
  import { discordAddToken, discordList, discordInfo, getValidResult } from '/@/api/df/discord';
  import { useMessage } from '/@/hooks/web/useMessage';
  import { copyText as doCopyText } from '/@/utils/copyTextToClipboard';

  const { createMessage, createSuccessModal, createErrorModal, createInfoModal } = useMessage();
  const props = defineProps({
    contentHeight: Number, // ‰Ω†ÁöÑ prop Á±ªÂûã
  });

  const queryForm = ref({
    discordState: null,
    mjState: null,
  });

  //************************************** discord Ë¥¶Âè∑Ê∑ªÂä† ****************************************************//
  const discordFormRef = ref();
  const discordForm = ref({
    viewFlag: false,
    loading: false,
    loadingTitle: '',
    title: '',
    notice: '',
    id: null,
    token: null,
  });
  const showDiscordForm = (record) => {
    if (record) {
      discordForm.value.id = record.id;
      discordForm.value.title = 'üí°Âà∑Êñ∞token‰ø°ÊÅØ(ËØ∑Á°ÆËÆ§tokenÂÄºÁöÑÊúâÊïàÊÄßÔºÅ)';
      discordForm.value.notice = 'üí°ËØ∑Á°ÆËÆ§tokenÂÄºÔºåÂ§±Ë¥•‰ºöÈòªÂ°ûÔºÅ';
      discordForm.value.viewFlag = true;
      discordForm.value.token = null;
      discordForm.value.loadingTitle = '';
    } else {
      discordForm.value.token = null;
      discordForm.value.viewFlag = true;
      discordForm.value.id = null;
      discordForm.value.notice = 'üí°ËØ∑Á°ÆËÆ§Âà∑Êñ∞ÁöÑtokenÂÄºÔºåÂ§±Ë¥•‰ºöÈòªÂ°û3ÂàÜÈíüÔºÅ';
      discordForm.value.title = 'üí°Ê∑ªÂä†DiscordË¥¶Âè∑(ËØ∑Á°ÆËÆ§tokenÂÄºÁöÑÊúâÊïàÊÄßÔºÅ)';
      discordForm.value.loadingTitle = '';
    }
  };
  const addDiscord = async () => {
    // Êèê‰∫§Êñ∞Â¢ûË¥¶Êà∑ÁöÑÊï∞ÊçÆ
    discordForm.value.loading = true;
    try {
      await discordFormRef.value.validate();
      const resp = await discordAddToken({ content: discordForm.value.token });
      dealResult(resp);
    } catch (ex) {
      discordForm.value.loading = false;
    }
  };

  const getResult = async () => {
    discordForm.value.loading = true;
    try {
      const resp = await getValidResult({});
      dealResult(resp);
    } catch (ex) {
      discordForm.value.loading = false;
    }
  };

  const dealResult = (resp) => {
    console.log('resp .....' + resp);
    if (resp.code === 0) {
      createMessage.success(resp.message);
      discordForm.value.loading = false;
      discordForm.value.viewFlag = false;
      onSearch();
      return;
    } else if (resp.code === 9999) {
      createMessage.error(resp.message);
      discordForm.value.loading = false;

      return;
    } else {
      discordForm.value.loadingTitle = resp.message;
      //ÂºÇÊ≠•Âæ™ÁéØÂä†ËΩΩ
      setTimeout(() => {
        getResult();
      }, 3000);
    }
  };

  const tableLoading = ref(false);

  const onSearch = async () => {
    tableLoading.value = true;
    try {
      const response = await discordList(queryForm.value);
      tableData.value = response;
    } finally {
      tableLoading.value = false;
    }
  };
  onMounted(() => {
    onSearch();
  });

  const copyText = async (text) => {
    const value = unref(text);
    if (!value) {
      createMessage.warning('ËØ∑ËæìÂÖ•Ë¶ÅÊã∑Ë¥ùÁöÑÂÜÖÂÆπÔºÅ');
      return;
    }
    doCopyText(value);
  };

  const getDiscordStateContent = (state) => {
    if (state === 'NORMAL') {
      return { text: 'Ê≠£Â∏∏', color: '#52c41a', status: 'processing' };
    } else if (state === 'EXPIRED') {
      return { text: 'ËøáÊúü', color: '#ff4d4f', status: 'error' };
    } else if (state === 'VERIFY_HUMAN') {
      return { text: 'È™åËØÅ‰∫∫Á±ª', color: '#d9d9d9', status: 'warning' };
    } else {
      return { text: 'Êú™Áü•', color: '#d9d9d9', status: 'default' };
    }
  };

  const getMjStateContent = (state) => {
    console.log('getMjStateContent   ' + state);
    if (state === 'NORMAL') {
      return { text: 'Â∑≤ËÆ¢ÈòÖ', color: '#52c41a', status: 'processing' };
    } else if (state === 'BAN') {
      return { text: 'BAN', color: '#ff4d4f', status: 'error' };
    } else if (state === 'STOP') {
      return { text: 'Êú™ËÆ¢ÈòÖ', color: '#d9d9d9', status: 'default' };
    } else {
      return { text: 'Êú™Áü•', color: '#d9d9d9', status: 'default' };
    }
  };

  // ‰∏ªtable Êï∞ÊçÆ
  const tableData = ref<{}[]>([
    // Êõ¥Â§öÊï∞ÊçÆ...
  ]);
</script>

<style scoped>
  .a-table {
    width: 100%;
    height: calc(80vh - 95px);
    padding: 10px;
    overflow: auto;
  }

  .ant-table-body {
    scrollbar-color: transparent transparent;
    scrollbar-width: thin; /* Firefox */

    /* Webkit Browsers (Safari, Chrome) */
    &::-webkit-scrollbar {
      width: 5px;
    }

    &::-webkit-scrollbar-thumb {
      background-color: transparent;
    }
  }
</style>
